generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id             Int             @id @default(autoincrement())
  email          String          @unique
  password       String
  username       String          @unique
  birthdate      DateTime
  profileId      Int
  createdAt      DateTime        @default(now())
  bookLists      BookList[]
  ratings        BookRating[]
  comments       Comment[]
  favoriteGenres FavoriteGenre[]
  posts          Post[]
  postComments   PostComment[]
  profile        UserProfile     @relation(fields: [profileId], references: [id])
  
  // Relaciones para el chat
  conversationParticipants ConversationParticipant[]
  sentMessages            Message[]
}

model UserProfile {
  id   Int     @id @default(autoincrement())
  bio  String?
  User User[]
}

model FavoriteGenre {
  id     Int    @id @default(autoincrement())
  name   String
  userId Int
  User   User   @relation(fields: [userId], references: [id])
}

model Book {
  id              String          @id
  title           String
  authors         String
  image           String?
  averageRating   Float?
  categories      String[]
  description     String?
  BookListEntries BookListEntry[]
  ratings         BookRating[]
  comments        Comment[]
}

model BookRating {
  id        Int      @id @default(autoincrement())
  rating    Int
  userId    Int
  bookId    String
  createdAt DateTime @default(now())
  book      Book     @relation(fields: [bookId], references: [id])
  user      User     @relation(fields: [userId], references: [id])

  @@unique([userId, bookId])
}

model BookList {
  id        Int             @id @default(autoincrement())
  name      String
  userId    Int
  createdAt DateTime        @default(now())
  user      User            @relation(fields: [userId], references: [id])
  entries   BookListEntry[]

  @@unique([name, userId])
}

model BookListEntry {
  id         Int      @id @default(autoincrement())
  bookId     String
  bookListId Int
  addedAt    DateTime @default(now())
  book       Book     @relation(fields: [bookId], references: [id])
  bookList   BookList @relation(fields: [bookListId], references: [id])
}

model Comment {
  id        Int      @id @default(autoincrement())
  content   String
  createdAt DateTime @default(now())
  userId    Int
  bookId    String
  book      Book     @relation(fields: [bookId], references: [id])
  user      User     @relation(fields: [userId], references: [id])
}

model Post {
  id         Int           @id @default(autoincrement())
  title      String
  content    String
  bookTitle  String?
  bookAuthor String?
  bookId     String?
  createdAt  DateTime      @default(now())
  updatedAt  DateTime      @updatedAt
  userId     Int
  user       User          @relation(fields: [userId], references: [id])
  comments   PostComment[]
}

model PostComment {
  id        Int      @id @default(autoincrement())
  content   String
  createdAt DateTime @default(now())
  userId    Int
  postId    Int
  post      Post     @relation(fields: [postId], references: [id])
  user      User     @relation(fields: [userId], references: [id])
}

// Modelos para el sistema de chat
model Conversation {
  id           Int       @id @default(autoincrement())
  name         String?   // Para chats grupales
  isGroup      Boolean   @default(false)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  lastMessage  String?
  lastMessageAt DateTime?
  
  participants ConversationParticipant[]
  messages     Message[]
}

model ConversationParticipant {
  id             Int          @id @default(autoincrement())
  userId         Int
  conversationId Int
  joinedAt       DateTime     @default(now())
  lastReadAt     DateTime?
  
  user           User         @relation(fields: [userId], references: [id])
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  
  @@unique([userId, conversationId])
}

model Message {
  id             Int          @id @default(autoincrement())
  content        String
  senderId       Int
  conversationId Int
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  messageType    MessageType  @default(TEXT)
  
  // Campos para notas de voz
  audioUrl       String?      // URL del archivo de audio en S3
  audioDuration  Int?         // Duración en segundos
  audioSize      Int?         // Tamaño del archivo en bytes
  transcription  String?      // Transcripción opcional del audio
  
  sender         User         @relation(fields: [senderId], references: [id])
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
}

enum MessageType {
  TEXT
  IMAGE
  BOOK_RECOMMENDATION
  VOICE_NOTE
}
